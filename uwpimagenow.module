<?php

require_once 'include/inow_connections.inc';
require_once 'include/inow_portals.inc';
/**
 * @file 
 * This Connects a Drupal webform to an ImageNow system
 * @author Stephen Corcoran
 */

/**
 * Implementation of the hook_menu()
 */
function uwpimagenow_menu() {
  $items = [];
  $items['admin/config/uwplatteville/imagenow'] = array(
    'title' => 'UW-Platteville ImageNow',
    'description' => 'Connect Drupal webforms to the ImageNow system. Tom Click Here!!!',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('uwpimagenow_admin_settings'),
    'access arguments' => array('administer uwpimagenow'),
    'file' => 'uwpimagenow.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  );
  $items['admin/config/uwplatteville/imagenow/portal'] = array(
    'title' => 'UW-Platteville ImageNow Portal',
    'description' => 'Portal Settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('uwpimagenow_portal_admin'),
    'access arguments' => array('administer uwpimagenow'),
    'file' => 'uwpimagenow_portal.inc',
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}

/**
 * Implementation of hook_permission
 */
function uwpimagenow_permission() {
  return array(
    'administer uwpimagenow' => array(
      'title' => t('Administer ImageNow Portal Control'),
      'description' => t('Access to ImageNow configuration'),
    ),
  );
}

function _inc_gen_file_keys_to($inowKeys, $value) {
  $elements = explode("-", $value);
  $inowKeysRtn = array();
  if (is_numeric($elements[0]) && is_numeric($elements[1]) &&
count($inowKeys) > 0) {
    foreach ($inowKeys as $inowKey) {
      for ($i = intval($elements[0]); $i <= intval($elements[1]); $i++)
{
        $inowKeysRtn[] = $inowKey . strval($i);
      }
    }
  } else if (is_numeric($elements[0]) && is_numeric($elements[1]) &&
count($inowKeys) == 0){
    for ($i = intval($elements[0]); $i <= intval($elements[1]); $i++) {
      $inowKeysRtn[] = strval($i);
    }
  } else if(count($inowKeys) > 0) {
    foreach ($inowKeys as $inowKey) {
      $currentChar = $elements[0];
      while ($currentChar <= $elements[1]) {
        $inowKeysRtn[] = $inowKey . $currentChar;
        ++$currentChar;
      }
    }
  } else if(count($inowKeys) == 0) {
    $currentChar = $elements[0];
    while ($currentChar <= $elements[1]) {
      $inowKeysRtn[] = $currentChar;
      ++$currentChar;
    }
  }
  return $inowKeysRtn;
}

function _inc_gen_file_keys_through_list($inowKeys, $value) {
  $elements = explode(",", $value);
  $inowKeysRtn = array();
  foreach ($inowKeys as $inowKey) {
    foreach ($elements as $element) {
      $inowKeysRtn[] = $inowKey . $element;
    }
  }
  return $inowKeysRtn;
}

function _inc_gen_file_keys($inowKeys, $value) {
  $inowKeysRtn = array();
  $value[0] = "";
  $value[strlen($value) - 1] = "";
  if (strpos($value, "-")) {
    $inowKeysRtn = _inc_gen_file_keys_to($inowKeys, trim($value));
  } else if (strpos($value, ",")) {
    $inowKeysRtn = _inc_gen_file_keys_through_list($inowKeys, $value);
  }
  return $inowKeysRtn;
}

function _gen_file_keys($inowKey) {
  $inowKeyArray = explode("/", $inowKey);
  $inowKeys = array();
  foreach ($inowKeyArray as $value) {
    if ($value[0] == '[') {
      $inowKeys = _inc_gen_file_keys($inowKeys, $value);
    } else {
      if (count($inowKeys) > 0) {
        foreach ($inowKeys as $key => $element) {
          $inowKeys[$key] = $element . $value;
        }
      } else {
        $inowKeys[] = $value;
      }
    }
  }
  return $inowKeys;
}

//function _print_file_keys($inowKey) {
//  $inowKeyArray = explode("/", $inowKey);
//  $inowKeys = array();
//  $inowKeys = _gen_file_keys($inowKeys, $inowKeyArray);
//
//  echo "Initial Value: " . $inowKey . "</br>";
//  echo "</br>";
//  echo "inowKeys Array Size: " . count($inowKeys) . "</br>";
//  echo "</br>";
//  echo "Generated File Keys:" . "</br>";
//  foreach ($inowKeys as $key) {
//    echo $key . "</br>";
//  }
//}

//$regx = "file_/[1,2,3,a,b,c]/_new";
//_print_file_keys($regx);
//echo "</br></br>";
//$regx = "[a-d]/_file_/[1-5]/_new";
//_print_file_keys($regx);
//echo "</br></br>";
//$regx = "file_/[a-f]/_new";
//_print_file_keys($regx);
  
function _submit_to_imagenow(&$form_values) {
  $portal = _get_portal_config($form_values['details']['nid'], FALSE);
  #dpm($portal);
//create array of data to be posted
  $post_data = NULL;
//Add the Defines to the URL params
  for ($i = 0; $i < count($portal['defines']); $i++) {
    $post_data[$portal['defines'][$i]['ikey']] = $portal['defines'][$i]['ivalue'];
  }
//Add the connection.
  $submitted_values = array();
  _get_subbmitted_values($submitted_values, $form_values['submitted']);
  #dpm("_get_subbmitted_values");
  #dpm($submitted_values);
  for ($i = 0; $i < count($portal['connections']); $i++) {
    $post_data[$portal['connections'][$i]['iek']] = $submitted_values[$portal['connections'][$i]['dek']];
  }
//FILE handle
  #dpm("Temp: " . file_directory_temp());
  for ($i = 0; $i < count($portal['files']); $i++) {
    if (array_key_exists($portal['files'][$i]['dek'], $form_values['submitted'])) {
      if (is_array($form_values['submitted'][$portal['files'][$i]['dek']])) {
        #dpm("Multi File...");
        $files = $form_values['submitted'][$portal['files'][$i]['dek']]["_fids"];
        $inowKeys = _gen_file_keys($portal['files'][$i]['iek']);

        foreach ($files as $key => $file) {
          $post_data[$inowKeys[$key]] = '@' . drupal_realpath(file_load($file)->uri);
        }
      }
      else {
        #dpm('File ' . $i . ' : ' . drupal_realpath(file_load($form_values['submitted'][$portal['files'][$i]['dek']])->uri));
        #dpm(file_load($submitted_values[$portal['files'][$i]['dek']])->uri);
        $post_data[$portal['files'][$i]['iek']] = '@' . drupal_realpath(file_load($submitted_values[$portal['files'][$i]['dek']])->uri);
      }
    }
    else {
      #dpm("No File Submission...");
    }
  }
//traverse array and prepare data for posting (key1=value1)
  foreach ($post_data as $key => $value) {
    $post_items[] = $key . '=' . $value;
  }
//create the final string to be posted using implode()
  $post_string = implode(' --form ', $post_items);

//we also need to add a question mark at the beginning of the string
//  $post_string = '?' . $post_string;
//  watchdog("CMO_PHP", "Args:" . $post_string);
  #dpm("Arg String:");
  #dpm($post_string);
//we are going to need the length of the data string
//  $data_length = strlen($post_string);
//  
###############################################################################
  $curl = 'curl --form ' . $post_string . ' ' . $portal['imagenow_url'];
//$curl = 'curl --data "' . $post_string . '" --form '. $file_string . $portal['imagenow_url'];
  #watchdog("CMO_PHP", $curl);
  exec($curl);

###############################################################################
//  //let's open the connection
//  $connection = fsockopen("104.131.178.250", 80);
//
////sending the data
//  fputs($connection, "POST  /cmo.php  HTTP/1.1\r\n");
//  fputs($connection, "Host:  " . "104.131.178.250" . " \r\n");
//  fputs($connection, "Content-Type: application/x-www-form-urlencoded\r\n");
//  fputs($connection, "Content-Length: $data_length\r\n");
//  fputs($connection, "Connection: close\r\n\r\n");
//  fputs($connection, $post_string);
//
////closing the connection
//  fclose($connection);
###############################################################################
//  //create cURL connection
//  $curl_connection = curl_init($portal['imagenow_url']);
//
////set options
//  curl_setopt($curl_connection, CURLOPT_CONNECTTIMEOUT, 30);
//  curl_setopt($curl_connection, CURLOPT_USERAGENT, "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)");
//  curl_setopt($curl_connection, CURLOPT_RETURNTRANSFER, true);
//  curl_setopt($curl_connection, CURLOPT_SSL_VERIFYPEER, false);
//  curl_setopt($curl_connection, CURLOPT_FOLLOWLOCATION, 1);
//
////set data to be posted
//  curl_setopt($curl_connection, CURLOPT_POSTFIELDS, $post_string);
//
////perform our request
//  $result = curl_exec($curl_connection);
////close the connection
//  curl_close($curl_connection);
}

/**
 * Implementation of hook_form_submit.
 * 
 * Take the ImageNow forms that pass validation
 * and submit them to imagenow system.
 * 
 * @param type $form_id
 * @param type $form_state
 */
function uwpimagenow_form_validate($form, &$form_state) {
  if (form_get_errors()) {
    return;
  }
  #dpm($_FILES);
  #dpm($form_state['values']);
  _submit_to_imagenow($form_state['values']);
}

/**
 * Implements hook_form_alter().
 */
function uwpimagenow_form_alter(&$form, &$form_state, $form_id) {
#dsm("Foo");
#dsm($form);
  if (!empty($form['details']['nid'])) {
    $tmp = _is_imagenow_form($form['details']['nid']['#value']);
    if ($tmp != NULL) {
      #dsm("ImageNow Form");
      $form['#validate'][] = 'uwpimagenow_form_validate';
    }
  }
}

function _get_subbmitted_values(&$flat_array, $array_in) {
  foreach ($array_in as $key => $value) {
    if (is_array($value) == false) {
      $flat_array[$key] = $value;
    }
    else {
      _get_subbmitted_values($flat_array, $value);
    }
  }
}
